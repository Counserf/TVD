# Чек-лист тестирования функций TVD

Этот чек-лист поможет проверить все функции TVD (Tactical Victory Determination) в Arma 3. Тестирование проводится в редакторе с минимальной миссией, консолью отладки и сервером/хостом. Убедитесь, что мод CBA_A3 установлен и активирован в лаунчере Arma 3.

---

## Подготовка тестовой миссии

### Создание миссии
- **Шаг**: 
  1. Откройте редактор Arma 3 (2D или 3DEN).
  2. Выберите карту (например, Stratis) и создайте новую миссию с именем `TVD_Test.Stratis`.
  3. Сохраните миссию через меню "Файл" → "Сохранить как".
  4. Скопируйте папку `TVD` из репозитория в корень миссии (путь: `Documents\Arma 3\missions\TVD_Test.Stratis\`).
- **Ожидаемый результат**: В папке миссии появляется подкаталог `TVD` со всеми скриптами (например, `config.sqf`, `core/main.sqf`, `client/admin_menu.sqf`).

### Настройка `init.sqf`
- **Шаг**: 
  1. В редакторе нажмите на кнопку "Сценарий" (иконка папки) или создайте файл `init.sqf` вручную в корне миссии.
  2. Откройте `init.sqf` в текстовом редакторе (например, Notepad++).
  3. Вставьте следующий код:
     '''sqf
     if (isServer) then {  
         waitUntil {sleep 1; count allPlayers > 0}; // Ожидает появления игроков
         [] execVM "TVD\core\main.sqf"; // Запускает основной скрипт TVD на сервере
     };
     if (hasInterface) then { 
         [] execVM "TVD\client\actions.sqf"; // Запускает клиентские действия для игроков
     };
     '''
  4. Сохраните файл.
- **Ожидаемый результат**: При запуске миссии сервер дождётся игроков и запустит TVD, а клиенты получат доступ к действиям (например, "Retreat"). Интерфейс администратора подключается через `TVD\core\init.sqf`.

### Создание баз
- **Шаг**: 
  1. В редакторе выберите инструмент "Триггеры" (иконка колокольчика).
  2. Создайте первый триггер:
     - Позиция: около точки спавна bluefor (например, `[1000, 1000, 0]`).
     - Размер: `A=50`, `B=50`, угол `0` (круг радиусом 50 м).
     - Активация: `Тип активации: ANYPLAYER`, `Условие: PRESENT`, `Повторяемый: Да`.
     - Переменная: В поле "Название" введите `trgBase_side0`.
  3. Создайте второй триггер:
     - Позиция: около точки спавна opfor (например, `[1500, 1500, 0]`).
     - Размер: `A=50`, `B=50`, угол `0`.
     - Активация: `Тип активации: ANYPLAYER`, `Условие: PRESENT`, `Повторяемый: Да`.
     - Переменная: В поле "Название" введите `trgBase_side1`.
  4. Сохраните миссию.
- **Ожидаемый результат**: Два триггера отображаются в редакторе, `trgBase_side0` привязан к bluefor (WEST), `trgBase_side1` — к opfor (EAST). В консоли после запуска видна их инициализация через `diag_log`.

### Размещение юнитов
- **Шаг**: 
  1. В редакторе выберите инструмент "Юниты" (иконка солдата).
  2. Для bluefor (WEST):
     - Разместите 5 играбельных юнитов NATO (например, "Rifleman") около `trgBase_side0` (в радиусе 50 м).
     - Выберите одного юнита, откройте его свойства, в поле "Инициализация" добавьте:
       '''sqf
       this setVariable ["TVD_UnitValue", [west, 50, "sideLeader"], true]; // Назначает юнита командиром bluefor
       '''
  3. Для opfor (EAST):
     - Разместите 5 играбельных юнитов CSAT (например, "Rifleman") около `trgBase_side1` (в радиусе 50 м).
     - Выберите одного юнита, в поле "Инициализация" добавьте:
       '''sqf
       this setVariable ["TVD_UnitValue", [east, 50, "sideLeader"], true]; // Назначает юнита командиром opfor
       '''
  4. Сохраните миссию.
- **Ожидаемый результат**: 10 юнитов (5 WEST, 5 EAST) видны на карте, по одному КС на сторону с повышенной ценностью (50 очков).

---

## Тестирование конфигурации (`config.sqf`)

### Проверка `TVD_CapZonesCount`
- **Шаг**: 
  1. Откройте `TVD/config.sqf` в текстовом редакторе.
  2. Установите `TVD_CapZonesCount = 2`.
  3. В редакторе выберите инструмент "Маркеры" (иконка флажка).
  4. Создайте маркер `mZone_0`:
     - Позиция: `[1200, 1200, 0]`.
     - Тип: `ellipse`, размер `A=50`, `B=50`, цвет `ColorBLUFOR`.
  5. Создайте маркер `mZone_1`:
     - Позиция: `[1300, 1300, 0]`.
     - Тип: `ellipse`, размер `A=50`, `B=50`, цвет `ColorOPFOR`.
  6. Сохраните миссию и запустите её в одиночной игре или на сервере.
  7. Откройте консоль отладки (Shift + F1) и выполните: `hint str TVD_InitScore`.
- **Ожидаемый результат**: В консоли отображается `TVD_InitScore = [50, 50, 0]` (по 50 очков за каждую зону), в RPT-файле (`diag_log`) видна инициализация зон.

### Проверка `TVD_RetreatPossible`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_RetreatPossible = [true, false]`.
  2. Запустите миссию.
  3. Убейте 4 из 5 юнитов bluefor и 4 из 5 юнитов opfor (например, через консоль: `{_x setDamage 1} forEach (allUnits select {side _x == west && _forEachIndex < 4})`).
  4. Подойдите к `trgBase_side0` юнитом bluefor и к `trgBase_side1` юнитом opfor.
  5. Откройте меню действий (колесо мыши) и попробуйте выбрать "Retreat to your rear".
- **Ожидаемый результат**: Для bluefor действие доступно и выполняется (юнит удаляется), для opfor появляется уведомление "Retreat not possible".

### Проверка `TVD_ZoneGain`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_ZoneGain = 100` и `TVD_CapZonesCount = 1`.
  2. Создайте маркер `mZone_0` (ColorBLUFOR, `[1200, 1200, 0]`, радиус 50 м).
  3. Запустите миссию.
  4. В консоли выполните: `hint str TVD_SidesZonesScore`.
- **Ожидаемый результат**: `TVD_SidesZonesScore = [100, 0]` (100 очков для bluefor).

### Проверка `TVD_RetreatRatio`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_RetreatRatio = 0.4`.
  2. Запустите миссию с 5 юнитами bluefor.
  3. Убейте 2 юнита bluefor (осталось 3/5, 60%).
  4. Подойдите к `trgBase_side0` и проверьте меню действий.
  5. Убейте ещё 1 юнит (осталось 2/5, 40%).
  6. Снова проверьте меню действий.
- **Ожидаемый результат**: Действие "Retreat" отсутствует при 3/5, появляется при 2/5 (40%).

### Проверка `TVD_SoldierCost`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_SoldierCost = 20`.
  2. Запустите миссию с 5 юнитами bluefor и 5 opfor.
  3. В консоли выполните: `hint str TVD_InitScore`.
- **Ожидаемый результат**: `TVD_InitScore = [100, 100, 0]` (5 × 20 для каждой стороны).

### Проверка `TVD_TimeExtendPossible` и `TVD_TimeExtendLimit`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_TimeExtendPossible = true`, `TVD_TimeExtendLimit = 1`, `a3a_endMissionTime = 60`.
  2. Запустите миссию.
  3. Дождитесь, пока до конца останется 5 секунд (в консоли: `hint str (missionNamespace getVariable "a3a_endMissionTime")`).
  4. Как КС bluefor выберите действие "Extend mission" в меню (колесо мыши).
  5. Проверьте время снова через консоль.
  6. Попробуйте продлить ещё раз.
- **Ожидаемый результат**: Время увеличивается до 300 секунд (5 минут), второе продление недоступно.

### Проверка `TVD_CriticalLossRatio`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_CriticalLossRatio = [0.6, 0.6]`.
  2. Запустите миссию с 5 юнитами bluefor.
  3. Убейте 2 юнита (осталось 3/5, 60%).
  4. Проверьте состояние миссии.
  5. Убейте ещё 1 юнит (осталось 2/5, 40%).
- **Ожидаемый результат**: При 3/5 миссия продолжается, при 2/5 завершается с причиной "Heavy Losses".

### Проверка `a3a_endMissionTime`
- **Шаг**: 
  1. В `TVD/config.sqf` установите `a3a_endMissionTime = 60`.
  2. Запустите миссию.
  3. Дождитесь 60 секунд (отслеживайте через консоль: `hint str (missionNamespace getVariable "a3a_endMissionTime")`).
- **Ожидаемый результат**: Миссия завершается через 60 секунд с причиной "Time's up" и отображает дебрифинг.

---

## Тестирование подсчёта очков (`score.sqf`)

### Очки за пехоту
- **Шаг**: 
  1. Запустите миссию с 5 юнитами bluefor и 5 opfor.
  2. Убейте 2 юнита bluefor (например, через консоль: `{_x setDamage 1} forEach (allUnits select {side _x == west && _forEachIndex < 2})`).
  3. В консоли выполните: `hint str TVD_SidesInfScore`.
- **Ожидаемый результат**: `TVD_SidesInfScore = [30, 50]` (3 × 10 для bluefor, 5 × 10 для opfor).

### Очки за ценные юниты
- **Шаг**: 
  1. В редакторе добавьте танк около `trgBase_side0`:
     - Тип: `B_MBT_01_TUSK_F` (или любой танк NATO).
     - Инициализация: `this setVariable ["TVD_UnitValue", [west, 100], true];`.
  2. Запустите миссию.
  3. Уничтожьте танк (например, через консоль: `vehicle cursorTarget setDamage 1`).
  4. В консоли выполните: `hint str TVD_SidesValScore`.
- **Ожидаемый результат**: `TVD_SidesValScore = [0, 0]` (танк мёртв, очки обнулены).

### Захват техники
- **Шаг**: 
  1. Добавьте танк с `this setVariable ["TVD_UnitValue", [west, 100], true];` около `trgBase_side0`.
  2. Запустите миссию.
  3. Подойдите юнитом opfor к танку и сядьте в него (действие "Get in").
  4. В консоли выполните: `hint str TVD_SidesValScore`.
- **Ожидаемый результат**: `TVD_SidesValScore = [0, 50]` (50% ценности за захват).

### Очки за зоны
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_CapZonesCount = 1`.
  2. Создайте маркер `mZone_0` (ColorBLUFOR, `[1200, 1200, 0]`, радиус 50 м).
  3. Запустите миссию.
  4. В консоли выполните: `hint str TVD_SidesZonesScore`.
- **Ожидаемый результат**: `TVD_SidesZonesScore = [50, 0]` (50 очков для bluefor).

---

## Тестирование задач (`tasks.sqf`)

### Создание задачи через код
- **Шаг**: 
  1. Откройте `init.sqf` и после кода TVD добавьте:
     '''sqf
     private _trigger = createTrigger ["EmptyDetector", [5000, 5000, 0], true];
     _trigger setTriggerArea [50, 50, 0, false];
     _trigger setTriggerActivation ["WEST", "PRESENT", true];
     _trigger setVariable ["TVD_TaskObject", [west, 100, "Захватить зону", true, ["false", "false", "false", "false", "true"], true], true];
     '''
  2. Сохраните миссию и запустите её.
  3. Подойдите юнитом WEST к координатам `[5000, 5000, 0]`.
- **Ожидаемый результат**: Появляется уведомление "Task Succeeded", миссия завершается с дебрифингом через `TVD_endMission`.

### Задача через редактор
- **Шаг**: 
  1. В редакторе создайте триггер:
     - Тип: `EmptyDetector`.
     - Позиция: `[5000, 5000, 0]`.
     - Размер: `A=50`, `B=50`, угол `0`.
     - Активация: `WEST`, `PRESENT`, повторяемая.
     - Условие: `this && (({side _x == east} count allPlayers) / ({side _x == west} count allPlayers) >= 3)`.
     - Переменная: `trigAdvantageWest`.
     - Инициализация:
       '''sqf
       this setVariable ["TVD_TaskObject", [west, 100, "Удержать позицию против перевеса", true, ["false", "false", "false", "false", "true"], true], true];
       '''
  2. Запустите миссию с 5 WEST и 5 EAST.
  3. Убейте 3 юнита WEST (осталось 2 против 5 EAST).
  4. Подойдите оставшимся юнитом WEST в зону триггера.
- **Ожидаемый результат**: Миссия завершается с уведомлением о выполнении задачи и дебрифингом.

---

## Тестирование отступления (`retreat.sqf`, `reserve.sqf`)

### Индивидуальное отступление
- **Шаг**: 
  1. Запустите миссию с 5 юнитами bluefor.
  2. Убейте 3 юнита bluefor (осталось 2/5).
  3. Подойдите оставшимся юнитом к `trgBase_side0`.
  4. Откройте меню действий (колесо мыши), выберите "Retreat to your rear", подтвердите.
  5. В консоли выполните: `hint str TVD_SidesResScore`.
- **Ожидаемый результат**: Юнит удаляется через 2 секунды, `TVD_SidesResScore = [10, 0]` (10 очков за солдата).

### Общее отступление КС
- **Шаг**: 
  1. Запустите миссию.
  2. Убейте 3/5 юнитов bluefor.
  3. Как КС bluefor выберите действие "Side: Order retreat" в меню действий.
  4. Подождите 5 секунд.
- **Ожидаемый результат**: Миссия завершается через `TVD_endMission`, техника вне базы передана opfor, дебрифинг показывает отступление.

### Отправка техники в резерв
- **Шаг**: 
  1. Добавьте танк около `trgBase_side0`:
     '''sqf
     this setVariable ["TVD_UnitValue", [west, 100], true];
     '''
  2. Запустите миссию.
  3. Подойдите к танку юнитом bluefor, выберите действие "Send vehicle to rear".
  4. Дождитесь 3 минут (ускорьте через консоль: `skipTime 0.05`).
  5. Проверьте `TVD_SidesResScore`.
- **Ожидаемый результат**: Танк исчезает через 3 минуты после красного дыма, `TVD_SidesResScore = [100, 0]`.

---

## Тестирование тяжёлых потерь (`heavy_losses.sqf`)

### Критические потери
- **Шаг**: 
  1. Запустите миссию с 5 юнитами bluefor.
  2. Убейте 4 юнита bluefor (осталось 1/5).
  3. Подождите 10 секунд (период проверки).
- **Ожидаемый результат**: Миссия завершается через `TVD_endMission` с причиной "Heavy Losses" и дебрифингом.

---

## Тестирование действий КС (`hq_transfer.sqf`, `actions.sqf`)

### Передача командования
- **Шаг**: 
  1. Запустите миссию с КС bluefor.
  2. Убейте КС bluefor (через консоль: `cursorTarget setDamage 1`).
  3. Подойдите к `trgBase_side0` другим юнитом bluefor (КО).
  4. Проверьте меню действий на наличие "Side: Order retreat".
- **Ожидаемый результат**: Новый КС (КО) получает уведомление и возможность отдать приказ на отступление.

### Продление времени
- **Шаг**: 
  1. В `TVD/config.sqf` установите `TVD_TimeExtendPossible = true`, `a3a_endMissionTime = 60`.
  2. Запустите миссию.
  3. Дождитесь 5 секунд до конца (проверьте через `hint str (missionNamespace getVariable "a3a_endMissionTime")`).
  4. Как КС bluefor выберите "Extend mission" в меню действий.
- **Ожидаемый результат**: Время увеличивается на 5 минут (300 секунд), уведомление об этом появляется.

---

## Тестирование интерфейса администратора (`admin_menu.sqf`)

### Открытие интерфейса
- **Шаг**: 
  1. Запустите миссию в мультиплеере как администратор (с правами #kick).
  2. Нажмите `Ctrl + ]`.
- **Ожидаемый результат**: Открывается диалог с тремя кнопками: "Техническое завершение", "Завершение без реплея", "Убить всех ботов".

### Техническое завершение
- **Шаг**: 
  1. В диалоге выберите "Техническое завершение".
- **Ожидаемый результат**: Миссия завершается через `TVD_endMission` с уведомлением, затемнением и 25-секундным дебрифингом, используя `a3a_fnc_endMission`.

### Завершение без реплея
- **Шаг**: 
  1. В диалоге выберите "Завершение без реплея".
- **Ожидаемый результат**: Появляется уведомление "Миссия завершена администратором" через `hint`, миссия завершается через `endMission` через 2 секунды без дебрифинга.

### Уничтожение ботов
- **Шаг**: 
  1. Добавьте 5 AI-юнитов (неиграбельных) для bluefor.
  2. В диалоге выберите "Убить всех ботов".
- **Ожидаемый результат**: Все AI-юниты уничтожаются мгновенно, игроки не получают уведомлений, смерти логируются в `TVD_MissionLog`.

---

## Тестирование логов и дебрифинга (`logging.sqf`)

### Логирование событий
- **Шаг**: 
  1. Запустите миссию.
  2. Убейте ценного юнита (например, КС bluefor).
  3. В консоли выполните: `hint str TVD_MissionLog`.
  4. Проверьте RPT-файл (Shift + F1 → "Лог ошибок").
- **Ожидаемый результат**: В `TVD_MissionLog` появляется запись о смерти (например, "КС убит"), в RPT — соответствующий `diag_log`.

### Дебрифинг
- **Шаг**: 
  1. В `TVD/config.sqf` установите `a3a_endMissionTime = 60`.
  2. Запустите миссию и дождитесь 60 секунд.
- **Ожидаемый результат**: После завершения появляется дебрифинг с заголовком "Time's up", показаны очки, потери и зоны через `TVD_writeDebrief`.

---

## Инструкции по тестированию

1. **Запуск миссии**: 
   - Используйте "Играть в одиночной игре" для быстрого теста или настройте сервер с CBA_A3 для мультиплеера.
   - Убедитесь, что в лаунчере Arma 3 включён CBA_A3.
2. **Консоль отладки**: 
   - Откройте консоль (Shift + F1), используйте команды вроде `hint str TVD_SidesInfScore` для проверки значений.
   - Для ускорения тестов используйте `skipTime 0.05` (ускоряет время на 3 минуты).
3. **Логи**: 
   - Открывайте RPT-файл (обычно в `C:\Users\<Имя>\AppData\Local\Arma 3`) или проверяйте через консоль `diag_log`.
4. **Сценарии**: 
   - Меняйте значения в `config.sqf` (например, `TVD_RetreatRatio = 0.2`) и перезапускайте миссию для проверки влияния.
5. **Союзники**: 
   - В редакторе настройте `INDEPENDENT` как союзника EAST (через "Атрибуты" → "Стороны"), замените bluefor на `INDEPENDENT` в тесте, чтобы проверить совместимость.

---

## Возможные проблемы и решения
- **Действия не появляются**: Убедитесь, что CBA_A3 активен и юнит находится в зоне триггера базы.
- **Миссия не завершается**: Проверьте правильность значений `TVD_CriticalLossRatio` и отсутствие ошибок в консоли.
- **Логи пустые**: Убедитесь, что `diag_log` не блокируется настройками сервера.
- **Интерфейс админа не открывается**: Проверьте права администратора (`#kick`) и подключение `admin_menu.sqf` через `init.sqf`.

---